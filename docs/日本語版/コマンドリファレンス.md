# コマンドリファレンス

このドキュメントでは、Speckitの全コマンドの詳細な使い方を説明します。

## 目次

- [コマンド一覧](#コマンド一覧)
- [/speckit.specify](#speckitspecify)
- [/speckit.clarify](#speckitclarify)
- [/speckit.plan](#speckitplan)
- [/speckit.tasks](#speckittasks)
- [/speckit.analyze](#speckitanalyze)
- [/speckit.implement](#speckitimplement)
- [/speckit.constitution](#speckitconstitution)
- [/speckit.checklist](#speckitchecklist)
- [/speckit.taskstoissues](#speckittaskstoissues)

## コマンド一覧

| コマンド | 必須/任意 | 入力 | 出力 | 説明 |
|---------|----------|------|------|------|
| `/speckit.specify` | 必須 | 機能説明 | spec.md | 機能仕様を作成 |
| `/speckit.clarify` | 任意 | - | spec.md (更新) | 仕様の曖昧さを解消 |
| `/speckit.plan` | 必須 | - | plan.md, research.md等 | 技術計画を作成 |
| `/speckit.tasks` | 必須 | - | tasks.md | タスクに分解 |
| `/speckit.analyze` | 任意 | - | レポート (表示のみ) | 整合性を検証 |
| `/speckit.implement` | 必須 | - | ソースコード | 実装を実行 |
| `/speckit.constitution` | 初回のみ | - | constitution.md | プロジェクト憲章を作成 |
| `/speckit.checklist` | 任意 | ドメイン | チェックリスト | 品質チェックリストを生成 |
| `/speckit.taskstoissues` | 任意 | - | GitHub Issues | タスクをIssueに変換 |

---

## /speckit.specify

### 概要

機能の仕様書を自然言語から生成します。これがすべてのワークフローの起点です。

### 構文

```bash
/speckit.specify [機能の説明]
```

### パラメータ

- **機能の説明** (必須): 自然言語で機能を説明
  - 文章の長さは自由 (1行〜複数段落)
  - 技術的な詳細よりユーザーの課題を記述

### 例

#### 例1: シンプルな説明

```bash
/speckit.specify ヘルスチェックエンドポイントを追加したい
```

#### 例2: 詳細な説明

```bash
/speckit.specify ユーザー認証機能を追加したい。メールアドレスとパスワードでログインできるようにし、パスワードを忘れた場合はリセットできるようにする。また、セッションは24時間有効とする。
```

#### 例3: 複数の要素を含む

```bash
/speckit.specify
決済機能を実装したい。以下の要件がある:
- クレジットカード決済に対応
- Stripe APIを使用する予定
- 領収書をメールで送信
- 決済履歴を確認できる
```

### 実行フロー

1. **ブランチ作成**
   - 機能名から短い名前を抽出 (例: "user-auth", "payment-integration")
   - 既存ブランチを確認し、次の番号を割り当て (例: `1-user-auth`)
   - 新しいブランチを作成してチェックアウト

2. **ディレクトリ初期化**
   ```
   specs/1-user-auth/
   └── spec.md
   ```

3. **仕様書生成**
   - 入力を分析し、ユーザーストーリーに変換
   - 機能要件を抽出
   - 成功基準を定義
   - テンプレートに従って構造化

4. **品質検証**
   - 仕様書の品質チェックリストを自動生成
   - 以下を検証:
     - 実装詳細が含まれていないか
     - 要件がテスト可能か
     - 成功基準が測定可能か

5. **曖昧さの処理**
   - 最大3つの `[NEEDS CLARIFICATION]` マーカーを挿入
   - ユーザーに選択肢を提示
   - 回答に基づいて仕様書を更新

### 出力

- **ブランチ**: `[番号]-[機能名]` (例: `1-user-auth`)
- **ファイル**: `specs/1-user-auth/spec.md`
- **チェックリスト**: `specs/1-user-auth/checklists/requirements.md`

### 生成される spec.md の構成

```markdown
# Feature Specification: ユーザー認証

**Feature Branch**: `1-user-auth`
**Created**: 2025-11-16
**Status**: Draft

## User Scenarios & Testing

### User Story 1 - アカウント作成 (Priority: P1)

新規ユーザーがメールアドレスとパスワードでアカウントを作成できる。

**Why this priority**: 認証の基盤として最優先

**Independent Test**: 登録フォームからアカウント作成し、ログインできることで検証

**Acceptance Scenarios**:
1. **Given** 未登録のメール、**When** 有効なパスワードで登録、**Then** アカウント作成成功
2. **Given** 既存のメール、**When** 登録を試みる、**Then** エラーメッセージ表示

## Requirements

### Functional Requirements

- **FR-001**: システムはメールアドレス形式を検証しなければならない
- **FR-002**: パスワードは最低8文字、英数字を含む必要がある

## Success Criteria

- **SC-001**: ユーザーは2分以内にアカウント作成を完了できる
- **SC-002**: システムは1000人の同時登録に対応できる
```

### ヒント

#### 良い機能説明の書き方

✅ **Good**:
```bash
/speckit.specify
ユーザーが商品をお気に入りに追加できる機能。
お気に入りリストは永続化され、次回ログイン時も見られる。
```

**理由**: ユーザーの課題と期待される動作が明確

❌ **Bad**:
```bash
/speckit.specify
データベースにfavoritesテーブルを作って、RESTful APIを実装する。
```

**理由**: 技術的な実装方法ではなく、ユーザーの課題を書く

#### 曖昧さのコントロール

仕様生成時、AIは以下の場合のみ `[NEEDS CLARIFICATION]` を使用します:
- スコープに大きく影響する決定
- セキュリティ/プライバシーに関わる決定
- 複数の合理的な解釈が存在する場合

それ以外は、業界標準やベストプラクティスに基づいて推測されます。

### 次のステップ

1. 生成された `spec.md` を確認
2. `[NEEDS CLARIFICATION]` があれば `/speckit.clarify` を実行
3. なければ `/speckit.plan` へ進む

---

## /speckit.clarify

### 概要

仕様書の曖昧な部分や不足している決定事項を、対話形式で明確化します。

### 構文

```bash
/speckit.clarify
```

### パラメータ

なし (現在のブランチの `spec.md` を自動的に使用)

### 前提条件

- `spec.md` が存在する
- 現在、機能ブランチにいる (例: `1-user-auth`)

### 実行フロー

1. **仕様書を分析**
   - `[NEEDS CLARIFICATION]` マーカーを検出
   - 曖昧な表現を特定 (「高速」「安全」など測定不能な形容詞)
   - 不足している決定事項を抽出

2. **質問を優先順位付け**
   - 影響度の高い順に最大5つの質問を選択
   - 優先順位: スコープ > セキュリティ > UX > 技術詳細

3. **対話形式で質問**
   - 1つずつ質問を提示
   - AIの推奨回答を提案
   - ユーザーの回答を待つ

4. **仕様書を更新**
   - 回答ごとに即座に `spec.md` を更新
   - `## Clarifications` セクションに記録
   - 関連する要件セクションを修正

### 質問の形式

#### パターン1: 選択肢形式

```markdown
## 質問1: セッションの有効期限

**コンテキスト**: FR-007でセッション管理が必要ですが、有効期限が未定です

**知りたいこと**: セッションの有効期限はどのくらいにしますか？

**推奨**: オプションB - 24時間が一般的で、UXとセキュリティのバランスが良い

| オプション | 説明 |
|----------|------|
| A | 1時間 - セキュア、頻繁な再ログイン必要 |
| B | 24時間 - バランス良、一般的 |
| C | 1週間 - UX良、セキュリティリスク高 |

回答方法: A, B, Cまたは"yes"で推奨を採用、独自の回答も可能
```

**回答例**:
- `B` → 24時間を採用
- `yes` or `recommended` → 推奨のB (24時間) を採用
- `3日` → 独自の回答 (3日)

#### パターン2: 短答形式

```markdown
## 質問2: データ保持期間

**コンテキスト**: 個人情報の保存期間が未定です

**知りたいこと**: ユーザーデータを何年保持しますか？

**提案**: 3年 - 一般的なビジネス要件に適合

回答方法: <=5語で回答。"yes"で提案を採用。

例: "5年", "無期限", "yes"
```

### 更新される spec.md

```markdown
## Clarifications

### Session 2025-11-16

- Q: セッションの有効期限は？ → A: 24時間
- Q: データ保持期間は？ → A: 3年

## Functional Requirements

- **FR-007**: セッションは24時間有効
- **FR-008**: ユーザーデータは3年間保持、その後削除
```

### 制限事項

- **最大5つの質問**: 影響度の高いものから
- **簡潔な回答**: 選択肢または5語以内
- **技術詳細より価値**: ビジネス判断を優先

### 早期終了

質問の途中でも、以下で終了できます:
- `done` → 質問を終了
- `good` → 現在まででOK
- `no more` → これ以上質問不要

### 次のステップ

1. すべての質問に回答
2. 更新された `spec.md` を確認
3. `/speckit.plan` へ進む

---

## /speckit.plan

### 概要

仕様書から技術的な実装計画を生成します。技術スタック、アーキテクチャ、データモデルを決定します。

### 構文

```bash
/speckit.plan
```

### パラメータ

なし (現在のブランチの `spec.md` を使用)

### 前提条件

- `spec.md` が完成している
- `[NEEDS CLARIFICATION]` マーカーが残っていない

### 実行フロー

#### Phase 0: 調査研究

1. **技術スタックの選定**
   - 仕様から技術要件を抽出
   - 各技術の選定理由を調査
   - ベストプラクティスを収集

2. **research.md 生成**
   ```markdown
   # Research: 認証方式

   ## Decision: OAuth2 with FastAPI

   **Rationale**:
   - 業界標準、セキュリティ実績あり
   - FastAPIはOAuth2ネイティブサポート

   **Alternatives considered**:
   - JWT only: リフレッシュトークンなし、柔軟性低
   - Session-based: スケーラビリティ課題
   ```

#### Phase 1: 設計

1. **データモデル設計**
   - 仕様からエンティティを抽出
   - リレーションシップを定義
   - `data-model.md` に記録

2. **API契約定義**
   - 機能要件からエンドポイントを導出
   - OpenAPI形式で記述
   - `contracts/` ディレクトリに配置

3. **プロジェクト構造決定**
   - 単一プロジェクト / Web / モバイル を判定
   - ディレクトリ構造を定義
   - `plan.md` に記録

4. **Agent コンテキスト更新**
   - `.claude/` ディレクトリのコンテキストファイルを更新
   - 新しい技術スタック情報を追加

### 出力ファイル

#### plan.md - 実装計画書

```markdown
# Implementation Plan: ユーザー認証

## Summary
OAuth2とJWTを使用したユーザー認証。Google, GitHubログイン対応。

## Technical Context

**Language/Version**: Python 3.11
**Primary Dependencies**: FastAPI, SQLAlchemy, authlib
**Storage**: PostgreSQL
**Testing**: pytest
**Project Type**: Web application

## Project Structure

### Source Code

backend/
├── src/
│   ├── models/
│   │   ├── user.py
│   │   └── session.py
│   ├── services/
│   │   ├── auth_service.py
│   │   └── session_service.py
│   └── api/
│       └── auth_routes.py
└── tests/
    ├── unit/
    └── integration/
```

#### data-model.md - データモデル

```markdown
# Data Model: ユーザー認証

## Entities

### User
- id: UUID (PK)
- email: String (unique, indexed)
- provider: String (google, github)
- created_at: DateTime

**Relationships**: User 1:N Session

### Session
- id: UUID (PK)
- user_id: UUID (FK → User)
- token: String (unique)
- expires_at: DateTime
```

#### contracts/auth.openapi.yaml

```yaml
openapi: 3.0.0
paths:
  /auth/login:
    post:
      summary: OAuth2ログイン開始
      parameters:
        - name: provider
          schema:
            type: string
            enum: [google, github]
      responses:
        '302':
          description: プロバイダーにリダイレクト
```

#### quickstart.md - クイックスタート

```markdown
# Quickstart: ユーザー認証

## 環境セットアップ

```bash
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

## データベース初期化

```bash
alembic upgrade head
```

## 起動

```bash
uvicorn src.main:app --reload
```

## テストシナリオ

### ログインフロー
1. GET /auth/login?provider=google
2. プロバイダーで認証
3. GET /auth/callback?code=...
4. トークン取得
```

### 憲章チェック

計画が `.specify/memory/constitution.md` の原則に違反していないか確認します。

**違反例**:
```
constitution.md: "TDD必須"
plan.md: テスト戦略の記載なし
→ CRITICAL エラー
```

### 次のステップ

1. 生成されたファイルをレビュー
2. 必要に応じて手動調整
3. `/speckit.tasks` へ進む

---

## /speckit.tasks

### 概要

実装計画をユーザーストーリーごとに整理された実行可能なタスクに分解します。

### 構文

```bash
/speckit.tasks
```

### パラメータ

なし (現在のブランチの `plan.md` と `spec.md` を使用)

### 前提条件

- `plan.md` が存在する
- `spec.md` にユーザーストーリーが定義されている

### 実行フロー

1. **設計ドキュメント読み込み**
   - `plan.md`: 技術スタック、プロジェクト構造
   - `spec.md`: ユーザーストーリー (優先度付き)
   - `data-model.md`: エンティティ
   - `contracts/`: APIエンドポイント

2. **タスク生成**
   - ユーザーストーリーごとにグループ化
   - 依存関係を分析
   - 並列実行可能なタスクを識別

3. **tasks.md 生成**

### タスクフォーマット (厳格)

```
- [ ] [TaskID] [P?] [Story?] 説明 ファイルパス
```

**例**:
```markdown
- [ ] T001 プロジェクト構造を作成
- [ ] T002 [P] 依存関係をインストール requirements.txt
- [ ] T006 [P] [US1] AuthServiceを実装 src/services/auth_service.py
```

**構成要素**:
- `- [ ]`: チェックボックス (必須)
- `[T001]`: タスクID (連番)
- `[P]`: 並列実行可能 (任意)
- `[US1]`: ユーザーストーリーラベル (ストーリーフェーズで必須)
- 説明: 具体的な作業内容
- ファイルパス: 対象ファイル (可能な限り)

### 生成される tasks.md の構造

```markdown
# Tasks: ユーザー認証

## Phase 1: Setup

- [ ] T001 プロジェクト構造を作成
- [ ] T002 [P] requirements.txtを作成
- [ ] T003 [P] .envファイルテンプレートを作成

## Phase 2: Foundational

- [ ] T004 Userモデルを作成 src/models/user.py
- [ ] T005 Sessionモデルを作成 src/models/session.py

## Phase 3: User Story 1 - Googleログイン (P1)

**Story Goal**: ユーザーがGoogleアカウントでログインできる

**Independent Test**: Googleログインボタンをクリックし、認証後にダッシュボード表示

### Implementation Tasks

- [ ] T006 [US1] OAuth2設定を追加 src/services/auth_service.py
- [ ] T007 [US1] ログインエンドポイントを作成 src/api/auth_routes.py
- [ ] T008 [P] [US1] コールバックエンドポイントを作成 src/api/auth_routes.py

## Phase 4: User Story 2 - GitHubログイン (P2)

**Story Goal**: GitHubアカウントでもログインできる

### Implementation Tasks

- [ ] T009 [P] [US2] GitHub OAuth2設定を追加 src/services/auth_service.py

## Phase 5: Polish

- [ ] T010 [P] エラーハンドリングを追加
- [ ] T011 統合テストを作成 tests/integration/test_auth.py

## Dependencies

Setup → Foundational → US1 (P1) → US2 (P2) → Polish
                    ↘ US2 (並列可能) ↗

## Parallel Execution Examples

**After Foundational**:
- US1とUS2は並列実装可能 (異なるプロバイダー)
```

### フェーズ構造

| フェーズ | 内容 | 例 |
|---------|------|-----|
| Phase 1: Setup | プロジェクト初期化 | 依存関係、環境変数、設定 |
| Phase 2: Foundational | 全ストーリー共通の基盤 | モデル、共通サービス |
| Phase 3+: User Stories | 各ストーリー (優先度順) | US1, US2, US3... |
| Final: Polish | 横断的な関心事 | エラーハンドリング、ログ、テスト |

### 並列実行の判定

以下の場合、`[P]` マーカーを付与:

✅ **並列実行可能**:
- 異なるファイルを扱う
- 依存関係がない
- 独立したモジュール

```markdown
- [ ] T005 [P] UserServiceを作成 src/services/user.py
- [ ] T006 [P] AuthServiceを作成 src/services/auth.py
```

❌ **並列実行不可**:
- 同じファイルを扱う
- 依存関係がある
- 順序が重要

```markdown
- [ ] T005 AuthServiceを作成 src/services/auth.py
- [ ] T006 AuthServiceにGoogle設定を追加 src/services/auth.py
```

### MVP (Minimum Viable Product)

通常、**P1 (最優先) のストーリーだけでMVP** となります:

```markdown
## Implementation Strategy

**MVP Scope**: Phase 1, 2, 3 (US1のみ)
- 最小限の価値を素早く提供
- US2, US3は段階的にリリース
```

### サマリーレポート

コマンド完了時、以下が表示されます:

```
✅ tasks.md 生成完了

Total Tasks: 11
- Phase 1 (Setup): 3 tasks
- Phase 2 (Foundational): 2 tasks
- Phase 3 (US1 - P1): 3 tasks
- Phase 4 (US2 - P2): 1 task
- Phase 5 (Polish): 2 tasks

Parallel Opportunities: 6 tasks ([P] marker)

MVP Scope: Phase 1-3 (6 tasks)

Next: /speckit.implement または /speckit.analyze で検証
```

### 次のステップ

1. `tasks.md` をレビュー
2. (任意) `/speckit.analyze` で整合性検証
3. `/speckit.implement` で実装開始

---

## /speckit.analyze

### 概要

spec.md, plan.md, tasks.md の整合性を検証し、矛盾・重複・不足を検出します。

### 構文

```bash
/speckit.analyze
```

### パラメータ

なし

### 前提条件

- `spec.md`, `plan.md`, `tasks.md` がすべて存在する

### 重要: 読み取り専用

**このコマンドはファイルを一切変更しません。** レポートのみを表示します。

### 検出項目

#### 1. 重複検出 (Duplication)

似た要件が複数定義されていないか:

```markdown
spec.md:
- FR-003: ユーザーはメールでログインできる
- FR-007: メールアドレスとパスワードでログイン

→ 重複の可能性
```

#### 2. 曖昧さ検出 (Ambiguity)

測定不能な表現:

```markdown
- SC-002: システムは高速に応答する

→ "高速"が曖昧。"1秒以内"などに変更推奨
```

#### 3. 不足検出 (Underspecification)

詳細が欠けている:

```markdown
- FR-009: システムはセキュアである

→ 具体性なし。何がセキュアか不明
```

#### 4. 憲章整合性 (Constitution Alignment)

`.specify/memory/constitution.md` との矛盾:

```markdown
constitution.md: "TDD必須"
plan.md: テスト戦略の記載なし

→ CRITICAL 違反
```

#### 5. カバレッジギャップ (Coverage Gap)

要件に対応するタスクがない、またはその逆:

```markdown
spec.md FR-010: 2要素認証を実装
tasks.md: 2要素認証に関するタスクなし

→ カバレッジギャップ
```

#### 6. 不整合 (Inconsistency)

用語の揺れや矛盾:

```markdown
spec.md: "ユーザー"
plan.md: "User", "アカウント"
tasks.md: "user", "account"

→ 用語を統一すべき
```

### レポート形式

```markdown
## Specification Analysis Report

| ID | Category | Severity | Location(s) | Summary | Recommendation |
|----|----------|----------|-------------|---------|----------------|
| A1 | Ambiguity | HIGH | spec.md:L45 | "高速"が測定不能 | "1秒以内"に変更 |
| C1 | Coverage Gap | MEDIUM | spec.md FR-009 | セキュリティタスクなし | CSRFトークン実装タスク追加 |
| K1 | Constitution | CRITICAL | plan.md | TDD未記載 | テスト戦略を追加 |

**Coverage Summary**:

| Requirement | Has Task? | Task IDs | Notes |
|-------------|-----------|----------|-------|
| FR-001: メール検証 | ✅ | T006 | |
| FR-002: OAuth2認証 | ✅ | T007, T008 | |
| FR-009: CSRF保護 | ❌ | - | 要タスク追加 |
| FR-010: 2要素認証 | ❌ | - | 要タスク追加 |

**Unmapped Tasks**:

| Task ID | Description | Note |
|---------|-------------|------|
| T012 | ログ設定 | 対応する要件なし (OK、横断的関心事) |

**Metrics**:
- Total Requirements: 12
- Total Tasks: 13
- Coverage: 83% (10/12)
- Critical Issues: 1
- High Issues: 1
- Medium Issues: 2
- Low Issues: 0

## Constitution Alignment Issues

| Principle | Violation | Location |
|-----------|-----------|----------|
| TDD必須 | テスト戦略未定義 | plan.md |

## Next Actions

❌ **CRITICAL issues found**:
1. plan.mdにテスト戦略を追加
2. `/speckit.plan` を再実行して憲章違反を解消

✅ **After fixes**:
- `/speckit.implement` で実装開始
```

### 重大度レベル

| 重大度 | 意味 | 対応タイミング |
|--------|------|--------------|
| CRITICAL | 憲章違反、実装不可 | 実装前に必ず修正 |
| HIGH | 矛盾、セキュリティ問題 | 実装前に修正推奨 |
| MEDIUM | 用語の揺れ、小さな不足 | 実装中に対応可 |
| LOW | スタイル、小さな冗長性 | 任意 |

### 制限事項

- 最大50件の検出結果を表示 (超過分は集約)
- コンテキスト効率化のため、最小限の情報のみ読み込み

### 次のステップ

#### CRITICAL/HIGH 問題がある場合

1. レポートを確認
2. 該当ファイルを手動修正
3. 必要に応じて `/speckit.plan` や `/speckit.tasks` を再実行
4. `/speckit.analyze` で再検証

#### 問題がない/MEDIUM以下のみ

1. `/speckit.implement` で実装開始
2. 実装中にMEDIUM問題を対応

---

## /speckit.implement

### 概要

tasks.md に定義されたタスクを段階的に実行し、実装を完了させます。

### 構文

```bash
/speckit.implement
```

### パラメータ

なし

### 前提条件

- `tasks.md` が存在する
- `plan.md` が存在する (技術スタックの参照)

### 実行フロー

#### 1. チェックリスト検証

`checklists/` ディレクトリにチェックリストがある場合、完了状況を確認:

```
| Checklist | Total | Completed | Incomplete | Status |
|-----------|-------|-----------|------------|--------|
| ux.md     | 8     | 8         | 0          | ✓ PASS |
| security.md | 5   | 3         | 2          | ✗ FAIL |
| testing.md | 10   | 10        | 0          | ✓ PASS |

❌ 一部のチェックリストが未完了です。実装を続行しますか? (yes/no)
```

- すべて完了 → 自動的に次へ
- 未完了あり → ユーザーに確認を求める

#### 2. コンテキスト読み込み

- `tasks.md`: タスク一覧と依存関係
- `plan.md`: 技術スタック、プロジェクト構造
- `data-model.md`: エンティティ定義
- `contracts/`: API仕様

#### 3. プロジェクトセットアップ

技術スタックに応じた無視ファイルを作成/検証:

**検出と作成**:
- Gitリポジトリ → `.gitignore`
- Dockerfile → `.dockerignore`
- Node.js → `.npmignore`, `.eslintignore`
- Python → `.gitignore` (Python用パターン)

**パターン例 (Python)**:
```gitignore
__pycache__/
*.pyc
.venv/
venv/
dist/
*.egg-info/
.env
*.log
```

#### 4. タスク実行

##### フェーズごとに実行

```
Phase 1: Setup 完了
  ↓
Phase 2: Foundational 完了
  ↓
Phase 3: US1 (P1) 完了
  ↓
...
```

各フェーズ完了後、次のフェーズへ進みます。

##### 依存関係を尊重

```markdown
- [ ] T004 Userモデルを作成 src/models/user.py
- [ ] T005 [P] Sessionモデルを作成 src/models/session.py  ← T004完了後、並列可
- [ ] T006 [P] AuthServiceを作成 src/services/auth.py   ← T004完了後、並列可
- [ ] T007 AuthServiceにUserを統合 src/services/auth.py ← T004, T006完了後
```

**実行順序**:
1. T004 実行
2. T004 完了後、T005とT006を並列実行
3. T005, T006 完了後、T007 実行

##### タスク完了マーク

タスク完了時、即座に `tasks.md` を更新:

```markdown
- [X] T004 Userモデルを作成 src/models/user.py
- [X] T005 [P] Sessionモデルを作成 src/models/session.py
- [ ] T006 [P] AuthServiceを作成 src/services/auth.py
```

#### 5. 進捗レポート

各タスク完了後:

```
✅ T004 完了: Userモデルを作成 (src/models/user.py)

Phase 2 進捗: 1/2 (50%)
全体進捗: 4/11 (36%)

次のタスク:
- T005 [P] Sessionモデルを作成
```

#### 6. エラーハンドリング

**順次タスクのエラー**:
```
❌ T007 失敗: AuthServiceにUserを統合

エラー: ImportError: cannot import name 'User' from 'src.models'

推奨アクション:
1. src/models/__init__.py にUserをエクスポート
2. T007を再実行

実装を停止しました。
```

**並列タスクのエラー**:
```
T005 ✅ 成功
T006 ❌ 失敗

T006のエラーにより、T007 (依存タスク) は保留されました。
T006を修正後、実装を再開してください。
```

#### 7. 完了検証

すべてのタスク完了後:

```markdown
## 実装完了レポート

✅ 全タスク完了: 11/11

**実装された機能**:
- ✅ User Story 1: Googleログイン (P1)
- ✅ User Story 2: GitHubログイン (P2)

**作成されたファイル**:
- src/models/user.py
- src/models/session.py
- src/services/auth_service.py
- src/api/auth_routes.py
- tests/integration/test_auth.py

**成功基準の検証 (推奨)**:
- SC-001: ログイン完了時間 < 2分 → 手動テスト必要
- SC-002: 1000同時ログイン対応 → 負荷テスト必要

**次のステップ**:
1. 統合テストを実行: `pytest tests/integration/`
2. 成功基準を検証
3. コードレビュー
4. デプロイ準備
```

### 実行中の操作

#### 一時停止

実装中にエラーが発生すると、自動的に停止します。

#### 再開

エラーを修正後、再度 `/speckit.implement` を実行すると:
- 完了済みタスク (`[X]`) はスキップ
- 未完了タスクから再開

#### 手動完了マーク

手動でコードを書いた場合、tasks.mdを直接編集してマーク:

```markdown
- [X] T005 [P] Sessionモデルを作成 src/models/session.py
```

次回の `/speckit.implement` 実行時、このタスクはスキップされます。

### 次のステップ

1. テストを実行
2. 成功基準を検証
3. コードレビュー
4. PRを作成 (必要に応じて)

---

## /speckit.constitution

### 概要

プロジェクト全体に適用される憲章 (不変の原則) を作成または更新します。

### 構文

```bash
/speckit.constitution
```

### パラメータ

なし (対話形式で原則を入力)

### いつ使うか

- プロジェクト開始時 (初回のみ)
- 重要な原則が変更される場合 (まれ)

### 憲章の役割

憲章は**交渉不可能な原則**を定義します:

- アーキテクチャパターン
- テスト戦略
- 品質基準
- 技術制約
- コーディング規約

すべての `spec.md`, `plan.md`, `tasks.md` は憲章に準拠しなければなりません。

### 憲章の例

```markdown
# My Project Constitution

**Version**: 1.0.0
**Ratified**: 2025-11-16
**Last Amended**: 2025-11-16

## Core Principles

### I. Library-First

すべての機能は独立したライブラリとして開始する。

**Requirements**:
- ライブラリは自己完結
- 独立してテスト可能
- ドキュメント必須
- 明確な目的必要 (組織目的のみのライブラリは禁止)

### II. CLI Interface

すべてのライブラリはCLI経由で機能を公開する。

**Protocol**:
- テキストin/out: stdin/args → stdout
- エラー → stderr
- JSON + 人間可読フォーマット対応

### III. Test-First (NON-NEGOTIABLE)

TDD必須:

1. テスト作成
2. ユーザー承認
3. テスト失敗確認
4. 実装

Red-Green-Refactorサイクルを厳格に実施。

### IV. Integration Testing

以下は統合テスト必須:

- 新しいライブラリの契約テスト
- 契約変更
- サービス間通信
- 共有スキーマ

### V. Observability

- テキストI/Oでデバッグ可能性を確保
- 構造化ログ必須
- すべてのエラーはトレース可能

## Governance

- 憲章はすべての実践に優先
- 改訂には文書化、承認、移行計画が必要
- すべてのPR/レビューで準拠を検証
- 複雑性には正当化が必要
```

### 憲章の検証

`/speckit.analyze` と `/speckit.plan` で自動的に検証されます。

**違反例**:

```markdown
constitution.md:
### III. Test-First (NON-NEGOTIABLE)

plan.md:
## Testing (記載なし)

→ CRITICAL エラー
```

### 憲章の更新

憲章を更新すると、既存のすべての機能ブランチで再検証が必要になる可能性があります。

### 次のステップ

1. 憲章を作成
2. チームでレビュー
3. 承認後、機能開発を開始

---

## /speckit.checklist

### 概要

特定ドメインの品質チェックリストを生成します。

### 構文

```bash
/speckit.checklist [ドメイン]
```

### パラメータ

- **ドメイン**: チェックリストの種類
  - `security`: セキュリティ
  - `ux`: ユーザー体験
  - `performance`: パフォーマンス
  - `accessibility`: アクセシビリティ
  - `testing`: テスト網羅性
  - カスタムドメインも可能 (例: "データプライバシー")

### 例

```bash
/speckit.checklist security
```

### 生成されるファイル

```
specs/1-user-auth/checklists/security.md
```

### チェックリストの例

#### security.md

```markdown
# Security Checklist: ユーザー認証

**Created**: 2025-11-16
**Feature**: [spec.md](../spec.md)

## Authentication & Authorization

- [ ] パスワードは安全にハッシュ化 (bcrypt/argon2)
- [ ] トークンは予測不可能 (最低32文字ランダム)
- [ ] セッション有効期限が適切に設定
- [ ] ログアウト機能が実装されている

## Input Validation

- [ ] SQLインジェクション対策 (パラメータ化クエリ)
- [ ] XSS対策 (入力サニタイズ)
- [ ] CSRF保護が有効

## Data Protection

- [ ] 個人情報は暗号化して保存
- [ ] HTTPS強制 (本番環境)
- [ ] 機密情報はログに出力しない

## Rate Limiting

- [ ] ログイン試行回数制限
- [ ] API呼び出し制限

## Monitoring

- [ ] 認証失敗をログに記録
- [ ] 異常なアクティビティを検出
```

#### ux.md

```markdown
# UX Checklist: ユーザー認証

## Usability

- [ ] エラーメッセージが明確で理解しやすい
- [ ] ローディング状態が視覚的に表示される
- [ ] 成功/失敗のフィードバックが即座に表示

## Accessibility

- [ ] キーボードのみで操作可能
- [ ] スクリーンリーダー対応
- [ ] 適切なARIAラベル

## Performance

- [ ] ページ読み込み時間 < 3秒
- [ ] ログイン処理 < 2秒
```

### 実装前の検証

`/speckit.implement` 実行時、チェックリストの完了状況を確認:

```
| Checklist | Completed | Status |
|-----------|-----------|--------|
| security.md | 8/10 | ✗ FAIL |
| ux.md | 5/5 | ✓ PASS |

一部のチェックリストが未完了です。実装を続行しますか?
```

### カスタムチェックリスト

独自のドメインを指定可能:

```bash
/speckit.checklist データプライバシー
```

生成例:

```markdown
# データプライバシー Checklist

- [ ] GDPRコンプライアンス
- [ ] ユーザーはデータ削除を要求できる
- [ ] データ収集の同意取得
- [ ] プライバシーポリシーへのリンク
```

### 次のステップ

1. チェックリストをレビュー
2. 実装中に項目をチェック
3. すべて完了後、実装を進める

---

## /speckit.taskstoissues

### 概要

tasks.md のタスクをGitHub Issueに変換し、依存関係も設定します。

### 構文

```bash
/speckit.taskstoissues
```

### パラメータ

なし

### 前提条件

- `tasks.md` が存在する
- GitHubリポジトリがセットアップされている
- `gh` CLI がインストール・認証済み

### 実行フロー

1. **tasks.md を解析**
   - 各タスクを抽出
   - 依存関係を分析
   - ユーザーストーリーとのマッピング

2. **GitHub Issueを作成**
   - タスクごとに1つのIssue
   - ラベルを自動付与 (P1, US1等)
   - 依存関係を説明に記載

3. **依存関係を設定**
   - GitHub Projectsまたはコメントで依存を明示

### 生成されるIssue例

#### Issue #1: T001 プロジェクト構造を作成

```markdown
## Task

プロジェクト構造をplan.mdに従って作成

## Details

- **Task ID**: T001
- **Phase**: Setup
- **Story**: -
- **File**: -

## Dependencies

なし (最初のタスク)

## Acceptance Criteria

- [ ] backend/ ディレクトリ作成
- [ ] src/ サブディレクトリ作成 (models, services, api)
- [ ] tests/ サブディレクトリ作成
```

**ラベル**: `phase:setup`, `p1`

#### Issue #6: T006 [US1] OAuth2設定を追加

```markdown
## Task

AuthServiceにOAuth2設定を追加

## Details

- **Task ID**: T006
- **Phase**: User Story 1
- **Story**: US1 (Googleログイン)
- **File**: `src/services/auth_service.py`
- **Parallel**: No

## Dependencies

- ✅ #4 (T004: Userモデル作成) が完了していること

## Acceptance Criteria

- [ ] Google OAuth2クライアントID/シークレットを設定
- [ ] authlib統合
- [ ] リダイレクトURI設定
```

**ラベル**: `phase:user-story`, `p1`, `us1`

### ラベル設定

自動的に以下のラベルが付与されます:

| ラベル | 意味 |
|-------|------|
| `phase:setup` | セットアップフェーズ |
| `phase:foundational` | 基盤フェーズ |
| `phase:user-story` | ユーザーストーリーフェーズ |
| `phase:polish` | 仕上げフェーズ |
| `p1`, `p2`, `p3` | 優先度 |
| `us1`, `us2`, ... | ユーザーストーリー番号 |
| `parallel` | 並列実行可能 |

### 依存関係の表現

GitHub Issueのコメントまたは説明で依存を明示:

```markdown
**Blocked by**:
- #4 T004: Userモデル作成
- #5 T005: Sessionモデル作成

**Blocks**:
- #8 T008: コールバックエンドポイント
```

### 並列実行の可視化

```markdown
**Can run in parallel with**:
- #5 T005: Sessionモデル作成
- #6 T006: AuthService作成
```

### 次のステップ

1. GitHub Issuesを確認
2. プロジェクトボードで進捗管理
3. Issueをアサイン
4. 実装開始

---

## まとめ: コマンドの選択

### 必須フロー (最小限)

```
/speckit.specify
   ↓
/speckit.plan
   ↓
/speckit.tasks
   ↓
/speckit.implement
```

### 推奨フロー (品質重視)

```
/speckit.specify
   ↓
/speckit.clarify    ← 曖昧さを解消
   ↓
/speckit.plan
   ↓
/speckit.tasks
   ↓
/speckit.analyze    ← 整合性検証
   ↓
/speckit.checklist  ← 品質チェックリスト
   ↓
/speckit.implement
```

### チーム開発フロー

```
/speckit.constitution    ← プロジェクト開始時のみ
   ↓
/speckit.specify
   ↓
/speckit.clarify
   ↓
/speckit.plan
   ↓
/speckit.tasks
   ↓
/speckit.taskstoissues  ← GitHub連携
   ↓
/speckit.implement
```

---

次は [実践例](./実践例.md) で実際の使い方を学びましょう。
